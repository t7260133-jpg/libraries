/*
 * Interrupt_BasicToggle
 * 
 * : Interrupts + Advanced Button
 * ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô - ‡πÉ‡∏ä‡πâ Interrupt ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
 * 
 * ‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î:
 * - ‡πÉ‡∏ä‡πâ attachInterrupt() ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ Polling ‡πÉ‡∏ô loop()
 * - ISR (Interrupt Service Routine) ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ delay() ‡∏´‡∏£‡∏∑‡∏≠ Serial.print()
 * - ‡πÉ‡∏ä‡πâ volatile ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô ISR
 * - ‡πÉ‡∏ä‡πâ IRAM_ATTR ‡∏ö‡∏ô ESP32 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ ISR ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô RAM ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
 * - ‡∏ó‡∏≥ Software Debounce ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô ISR
 * 
 * ‡∏ß‡∏á‡∏à‡∏£ (ESP32 ICON-32):
 * - ‡∏õ‡∏∏‡πà‡∏°: GPIO 4 ‚Üí GND (‡πÉ‡∏ä‡πâ INPUT_PULLUP)
 * - LED:  GPIO 2 ‚Üí 220Œ© ‚Üí GND (Built-in LED)
 * 
 * ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°:
 * - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚Üí Toggle LED ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
 * - loop() ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤)
 * 
 * Author: Micro-Docs Library
 * License: MIT
 */

#include <Arduino.h>

// ==================== ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ====================
const int BUTTON_PIN = 4;  // ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î
const int LED_PIN = 2;     // LED (Built-in ‡∏ö‡∏ô ESP32)

// ==================== ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ ISR ====================
// ‚ö†Ô∏è ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô ISR ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô volatile
volatile bool flagToggleLED = false;
volatile unsigned long lastInterruptTime = 0;

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debounce (ms)
const unsigned long DEBOUNCE_TIME = 150;

// ==================== ISR Function ====================
/**
 * ISR (Interrupt Service Routine)
 * ‚ö†Ô∏è ‡∏Å‡∏é‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô ISR:
 * 1. ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ delay()
 * 2. ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ Serial.print()
 * 3. ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÄ‡∏£‡πá‡∏ß
 * 4. ‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏ò‡∏á (flag) ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÉ‡∏ô loop()
 */
void handleButtonPress() {
  unsigned long now = millis();
  
  // Software debounce ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
  if (now - lastInterruptTime > DEBOUNCE_TIME) {
    flagToggleLED = true;      // ‡∏ï‡∏±‡πâ‡∏á‡∏ò‡∏á‡πÉ‡∏´‡πâ loop() ‡πÑ‡∏õ toggle LED
    lastInterruptTime = now;
  }
}

// ==================== Setup ====================
void setup() {
  Serial.begin(115200);
  delay(500);
  
  Serial.println("=== : Interrupt Basic Toggle ===");
  Serial.println("‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚Üí Toggle LED (‡πÉ‡∏ä‡πâ Interrupt)");
  Serial.println();
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≤
  pinMode(LED_PIN, OUTPUT);
  pinMode(BUTTON_PIN, INPUT_PULLUP);
  
  // ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Interrupt
  // FALLING = ‡∏Ç‡∏≠‡∏ö‡∏•‡∏á (‡∏à‡∏≤‡∏Å HIGH ‚Üí LOW) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°
  attachInterrupt(
    digitalPinToInterrupt(BUTTON_PIN),
    handleButtonPress,
    FALLING
  );
  
  Serial.println("‚úì Interrupt ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß");
  Serial.println("‚úì ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠ Toggle LED");
  Serial.println();
}

// ==================== Loop ====================
void loop() {
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ò‡∏á‡∏à‡∏≤‡∏Å ISR
  if (flagToggleLED) {
    flagToggleLED = false;  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ò‡∏á
    
    // Toggle LED
    digitalWrite(LED_PIN, !digitalRead(LED_PIN));
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    bool ledState = digitalRead(LED_PIN);
    Serial.print("LED: ");
    Serial.println(ledState ? "ON" : "OFF");
  }
  
  // =============================================
  // ‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
  // (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ delay ‡∏´‡∏£‡∏∑‡∏≠ polling ‡∏õ‡∏∏‡πà‡∏°)
  // =============================================
  
  static unsigned long lastPrint = 0;
  unsigned long now = millis();
  
  // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå‡∏ß‡πà‡∏≤ loop() ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà
  if (now - lastPrint >= 2000) {
    lastPrint = now;
    Serial.print("‚è± Runtime: ");
    Serial.print(now / 1000);
    Serial.println(" s");
  }
}

/*
 * ==================== ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ====================
 * 
 * üìå Polling vs Interrupt
 * 
 * ‡πÅ‡∏ö‡∏ö Polling ():
 * - ‡∏≠‡πà‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô loop() ‡∏ï‡∏•‡∏≠‡∏î
 * - ‡∏ñ‡πâ‡∏≤ loop() ‡∏ä‡πâ‡∏≤ (‡∏°‡∏µ delay) ‚Üí ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏à‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏ä‡πâ‡∏≤
 * 
 * ‡πÅ‡∏ö‡∏ö Interrupt :
 * - CPU ‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
 * - ‡πÑ‡∏õ‡∏ó‡∏≥ ISR ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‚Üí ‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÄ‡∏£‡πá‡∏ß
 * - loop() ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
 * 
 * ‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á:
 * 1. ISR ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πâ‡∏ô ‡πÄ‡∏£‡πá‡∏ß
 * 2. ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ delay(), Serial.print() ‡πÉ‡∏ô ISR
 * 3. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô volatile
 * 4. ‡∏ö‡∏ô ESP32 ‡πÉ‡∏ä‡πâ IRAM_ATTR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ ISR ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô RAM
 * 
 * ==================== Debug Tips ====================
 * 
 * ‡∏ñ‡πâ‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏±‡∏á‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏ã‡πâ‡∏≥ (bounce):
 * - ‡πÄ‡∏û‡∏¥‡πà‡∏° DEBOUNCE_TIME (‡πÄ‡∏ä‡πà‡∏ô 200ms)
 * - ‡πÉ‡∏ä‡πâ Hardware Debounce (RC Filter)
 * - ‡πÉ‡∏ä‡πâ AdvancedButton class
 * 
 * ‡∏ñ‡πâ‡∏≤ LED ‡πÑ‡∏°‡πà Toggle:
 * - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö pinMode() ‡∏ß‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
 * - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö volatile flag
 * - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö FALLING/RISING ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏á‡∏à‡∏£
 */
